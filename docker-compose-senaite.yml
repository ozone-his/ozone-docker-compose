services:

  # SENAITE
  senaite:
    depends_on: 
      env-substitution:
        condition: service_completed_successfully
    environment: 
      - SITE=${SITE}
      - ADMIN_USER=${SENAITE_ADMIN_USER}
      - ADMIN_PASSWORD=${SENAITE_ADMIN_PASSWORD}
    image: mekomsolutions/senaite:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.senaite.loadbalancer.server.port=8080"
      - "traefik.http.routers.senaite.rule=Host(`${SENAITE_HOSTNAME}`)"
      - "traefik.http.routers.senaite.middlewares=senaite"
      - "traefik.http.middlewares.senaite.addprefix.prefix=/VirtualHostBase/https/${SENAITE_HOSTNAME}/senaite/VirtualHostRoot"
    networks:
      - ozone
      - web
    restart: unless-stopped
    volumes:
      - ${SENAITE_CONFIG_PATH}:/data/importdata/senaite
      - senaite-filestorage:/data/filestorage
      - senaite-blobstorage:/data/blobstorage

  # OpenMRS - SENAITE integration service
  eip-openmrs-senaite:
    depends_on:
      env-substitution:
        condition: service_completed_successfully
      openmrs:
        condition: service_healthy
      mysql:
        condition: service_started
      senaite:
        condition: service_started
    env_file: eip.env
    environment:
      - SENAITE_SERVER_URL=https://${SENAITE_HOSTNAME}/senaite
      - SENAITE_SERVER_USER=${SENAITE_ADMIN_USER}
      - SENAITE_SERVER_PASSWORD=${SENAITE_ADMIN_PASSWORD}
      - OPENMRS_SERVER_URL=http://openmrs:8080/openmrs
      - OPENMRS_SERVER_USER=${OPENMRS_USER}
      - OPENMRS_SERVER_PASSWORD=${OPENMRS_PASSWORD}
      - OPENMRS_RESULTS_ENCOUNTER_TYPE_UUID=${RESULTS_ENCOUNTER_TYPE_UUID}
      - OPENMRS_IDENTIFIER_TYPE_UUID=${OPENMRS_IDENTIFIER_TYPE_UUID}
      - OPENMRS_CONCEPT_COMPLEX_UUID=${CONCEPT_COMPLEX_UUID}
      - BAHMNI_TEST_ORDER_TYPE_UUID=${BAHMNI_TEST_ORDER_TYPE_UUID}
      - EIP_PROFILE=prod
      - EIP_WATCHED_TABLES=patient,person_name,person_address,patient_identifier,orders,test_order
      - EIP_DB_NAME_SENAITE=${EIP_DB_NAME_SENAITE}
      - EIP_DB_USER_SENAITE=${EIP_DB_USER_SENAITE}
      - EIP_DB_PASSWORD_SENAITE=${EIP_DB_PASSWORD_SENAITE}
      - DB_EVENT_DESTINATIONS_SENAITE=${DB_EVENT_DESTINATIONS_SENAITE}
    image: mekomsolutions/eip-client
    networks:
      ozone:
        aliases:
          - eip-client-senaite
    restart: unless-stopped
    volumes:
      - "${EIP_OPENMRS_SENAITE_ROUTES_PATH}:/eip-client/routes"
      - eip-home-senaite:/eip-home

  mysql:
    environment:
      EIP_DB_NAME_SENAITE: ${EIP_DB_NAME_SENAITE}
      EIP_DB_USER_SENAITE: ${EIP_DB_USER_SENAITE}
      EIP_DB_PASSWORD_SENAITE: ${EIP_DB_PASSWORD_SENAITE}
    volumes:
      - "${SQL_SCRIPTS_PATH}/mysql/eip-openmrs-senaite:/docker-entrypoint-initdb.d/db/eip-openmrs-senaite"
    
  env-substitution:
    environment:
      - SENAITE_PUBLIC_URL=https://${SENAITE_HOSTNAME}

volumes:
  eip-home-senaite: ~
  senaite-blobstorage: ~
  senaite-filestorage: ~
