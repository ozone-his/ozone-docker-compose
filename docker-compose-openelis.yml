version: '3.6'

x-logging:
  &local-logging
  driver: "local"
  options:
    max-size: "20m"
    max-file: "50"

x-loki-logging:
  &loki-logging
  driver: "loki"
  options:
    max-size: "20m"
    max-file: "50"
    loki-url: "[% loki_url %]"
    loki-external-labels: "container_name={{.Name}},hostname=[% host_name %]"
    loki-pipeline-stages: |
      - multiline:
          firstline: '^\d{4}-\d{2}-\d{2}[T ]?\d{2}:\d{2}:\d{2}.\d{3}'
      - labeldrop:
          - compose_project
          - compose_service
          - filename
          - source
          - stream
          - swarm_service
          - swarm_stack
services:
  certs:
    container_name: oe-certs
    image: itechuw/certgen:main
    platform: linux/amd64
    restart: always
    environment:
      - KEYSTORE_PW="kspass"
      - TRUSTSTORE_PW="tspass"
    networks:
      - openelis-network
    volumes:
      -  key_trust-store-volume:/etc/openelis-global
      -  keys-vol:/etc/ssl/private/
      -  certs-vol:/etc/ssl/certs/

  db.openelis.org:
    container_name: openelisglobal-database
    image: itechuw/openelis-global-2-database:develop
    platform: linux/amd64
    ports:
      - "15432:5432"
    restart: always
    env_file:
      - ../../distro/binaries/openelis/volumes/database/database.env
    environment:
      - DB_PASSWORD=${OE_DB_PASSWORD}
      - DB_SUPERUSER_PASSWORD=${ADMIN_PASSWORD}
    volumes:
      # preserves the database between containers
      - ../../distro/binaries/openelis/volumes/database/data:/var/lib/postgresql/data

    logging: *local-logging
    networks:
      - openelis-network
    healthcheck:
      test: [ "CMD", "pg_isready", "-q", "-d", "clinlims", "-U", "clinlims" ]
      timeout: 45s
      interval: 10s
      retries: 10

  oe.openelis.org:
    container_name: openelisglobal-webapp
    image: itechuw/openelis-global-2:develop
    platform: linux/amd64
    depends_on:
      - db.openelis.org
      - certs
    ports:
      - "8085:8080"
      - "8443:8443"
    restart: always
    networks:
      openelis-network:
        ipv4_address: 172.20.1.121
    logging: *local-logging
    environment:
      - DEFAULT_PW=adminADMIN!
      - TZ=America/New_York
      # Config variables loaded through Tomacat server.xml
      - CATALINA_OPTS= -Ddatasource.url=jdbc:postgresql://db.openelis.org:5432/clinlims -Ddatasource.username=clinlims -Ddatasource.password=${OE_DB_PASSWORD} -Doe.ssl.truststorepath=${SSL_TRUSTSTORE_PATH} -Doe.ssl.truststorepassword=${SSL_TRUSTSTORE_PASSWORD} -Doe.ssl.keystorepath=${SSL_KEYSTORE_PATH} -Doe.ssl.keystorepassword=${SSL_KEYSTORE_PASSWORD}
      # Env variables passed to the common properties file
      - SSL_KEYSTORE_PATH
      - SSL_KEYSTORE_PASSWORD
      - SSL_TRUSTSTORE_PATH
      - SSL_TRUSTSTORE_PASSWORD
    volumes:
      -  key_trust-store-volume:/etc/openelis-global
      - ../../distro/binaries/openelis/volumes/plugins/:/var/lib/openelis-global/plugins
      - ../../distro/binaries/openelis/volumes/logs/oeLogs:/var/lib/openelis-global/logs
      - ../../distro/binaries/openelis/volumes/logs/tomcatLogs/:/usr/local/tomcat/logs
      - ../../distro/binaries/openelis/volumes/properties/SystemConfiguration.properties:/var/lib/openelis-global/properties/SystemConfiguration.properties
      - ../../distro/binaries/openelis/volumes/analyzer/analyzer-test-map.csv:/var/lib/openelis-global/analyzer/analyzer-test-map.csv
      - ../../distro/binaries/openelis/volumes/odoo/odoo-test-product-mapping.csv:/var/lib/openelis-global/odoo/odoo-test-product-mapping.csv
      - ../../distro/binaries/openelis/volumes/ocl:/var/lib/openelis-global/ocl
      -  lucene_index-vol:/var/lib/lucene_index
    secrets:
      - source: common.properties

  fhir.openelis.org:
    container_name: external-fhir-api
    image: itechuw/openelis-global-2-fhir:develop
    platform: linux/amd64
    ports:
      - "8086:8080"
      - "8444:8443"
    depends_on:
      - db.openelis.org
      - certs
    networks:
      - openelis-network
    restart: always
    environment:
      TZ: America/New_York

      JAVA_OPTS: "-Djavax.net.ssl.trustStore=${SSL_TRUSTSTORE_PATH}
                      -Djavax.net.ssl.trustStorePassword=${SSL_TRUSTSTORE_PASSWORD}
                      -Djavax.net.ssl.trustStoreType=pkcs12
                      -Djavax.net.ssl.keyStore=${SSL_KEYSTORE_PATH}
                      -Djavax.net.ssl.keyStorePassword=${SSL_KEYSTORE_PASSWORD}
                      -Djavax.net.ssl.keyStoreType=pkcs12"
      # Config variables loaded through Tomacat server.xml
      CATALINA_OPTS: "-Dhapi.ssl.truststorepath=${SSL_TRUSTSTORE_PATH} -Dhapi.ssl.truststorepassword=${SSL_TRUSTSTORE_PASSWORD} -Dhapi.ssl.keystorepath=${SSL_KEYSTORE_PATH} -Dhapi.ssl.keystorepassword=${SSL_KEYSTORE_PASSWORD}"
      # Config variables loaded through Hapi application.yml
      FHIR_DATASOURCE_URL : "jdbc:postgresql://db.openelis.org:5432/clinlims?currentSchema=clinlims"
      FHIR_DATASOURCE_USERNAME: "clinlims"
      FHIR_DATASOURCE_PASSWORD: ${OE_DB_PASSWORD}
      FHIR_SERVER_ADRESS: "http://fhir.openelis.org:8080/fhir/"

    logging: *local-logging
    volumes:
      -  key_trust-store-volume:/etc/openelis-global

  frontend.openelis.org:
    image: itechuw/openelis-global-2-frontend:develop
    container_name: openelisglobal-front-end
    platform: linux/amd64
    networks:
      - openelis-network
    environment:
      - CHOKIDAR_USEPOLLING=true
    logging: *local-logging
    tty: true

  openelis.proxy:
    image: itechuw/openelis-global-2-proxy:develop
    container_name: openelisglobal-proxy
    platform: linux/amd64
    ports:
      - 81:80
      - 443:443
    volumes:
      - certs-vol:/etc/nginx/certs/
      - keys-vol:/etc/nginx/keys/
      - ../../distro/binaries/openelis/volumes/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # - /KEYSTORE_PASSWORD:/etc/nginx/private/key_pass
      # - /etc/openelis-global/nginx.cert.pem:/etc/nginx/certs/cert.crt
      # - /etc/openelis-global/nginx.key.pem:/etc/nginx/certs/cert.key
    restart: unless-stopped
    networks:
      - openelis-network
    logging: *local-logging
    depends_on:
      - certs

  # astm-http-bridge:
  #     container_name: astm-http-bridge
  #     image: itechuw/astm-http-bridge:2.3.6
  #     platform: linux/amd64
  #     pull_policy: always
  #     ports:
  #         - "8445:8443"
  #         - "12001:12001"
  #     volumes:
  #         - ../../distro/binaries/openelis/volumes/astm/configuration.yml:/app/configuration.yml
  #         -  key_trust-store-volume:/etc/openelis-global
  #     environment:
  #         SPRING_PROFILE: dev
  #         LOGGING_LEVEL_ORG_ITECH: TRACE
  #         JAVA_OPTS: |
  #             -Djavax.net.ssl.trustStore=/etc/openelis-global/truststore
  #             -Djavax.net.ssl.trustStorePassword=tspass
  #             -Djavax.net.ssl.trustStoreType=pkcs12
  #     logging: *local-logging
  #     networks:
  #         - openelis-network
  #     healthcheck:
  #         test: ["CMD", "/app/healthcheck.sh"]
  #         timeout: 10s
  #         interval: 30s
  #         retries: 3
  #         start_period: 2m


  autoheal:
    container_name: autoheal-oe
    image: willfarrell/autoheal:1.2.0
    tty: true
    restart: always
    networks:
      - openelis-network
    environment:
      AUTOHEAL_CONTAINER_LABEL: all
      TZ: America/New_York
    logging: *local-logging
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

secrets:
  common.properties:
    file:  ../../distro/binaries/openelis/volumes/properties/common.properties

networks:
  openelis-network:
    name: openelis-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.1.0/24

volumes:
  db-data:
  key_trust-store-volume:
  certs-vol:
  keys-vol:
  lucene_index-vol: